syntax = "v1"

info(
    title: "代理收益查询接口"
    desc: "提供代理收益查询功能，包括佣金统计、收益明细、下级业绩等"
    version: "v1.0"
)

import "../../common/types.api"

@server(
    prefix: /api/fams/agent/income
    group: famsAgentIncome
    tags: "FAMS/代理/收益"
)
service admin {
    @doc(
        summary: "代理收益总览"
        description: "获取代理收益总览数据，包括总佣金、本月佣金、下级业绩等"
        id: "fams.agent.income.overview"
    )
    @handler getEarningsOverview
    get /:userId/overview (GetEarningsOverviewReq) returns (GetEarningsOverviewResp)

    @doc(
        summary: "收益明细列表"
        description: "获取代理收益明细列表，支持多维度筛选"
        id: "fams.agent.income.list"
    )
    @handler listEarnings
    get /:userId/earnings (ListEarningsReq) returns (ListEarningsResp)

    @doc(
        summary: "收益明细详情"
        description: "根据ID获取收益明细详情"
        id: "fams.agent.income.detail"
    )
    @handler getEarningDetail
    get /earnings/:id (IdReq) returns (GetEarningDetailResp)

    @doc(
        summary: "下级业绩统计"
        description: "获取代理下级用户的业绩统计数据"
        id: "fams.agent.income.subUsers"
    )
    @handler getSubUserPerformance
    get /:userId/sub-performance (GetSubUserPerformanceReq) returns (GetSubUserPerformanceResp)

    @doc(
        summary: "佣金比例配置"
        description: "获取代理的佣金比例配置"
        id: "fams.agent.income.commission"
    )
    @handler getCommissionConfig
    get /:userId/commission (GetCommissionConfigReq) returns (GetCommissionConfigResp)

    @doc(
        summary: "收益趋势分析"
        description: "获取代理收益的趋势分析数据（按日/月统计）"
        id: "fams.agent.income.trend"
    )
    @handler getEarningsTrend
    get /:userId/trend (GetEarningsTrendReq) returns (GetEarningsTrendResp)

    @doc(
        summary: "导出收益报表"
        description: "导出代理收益报表为Excel文件"
        id: "fams.agent.income.export"
    )
    @handler exportEarnings
    post /:userId/export (ExportEarningsReq) returns (ExportEarningsResp)
}

type (
    // 代理收益总览请求
    GetEarningsOverviewReq {
        UserId int64 `path:"userId"` // 用户ID
        StartTime int64 `form:"startTime,optional"` // 开始时间（毫秒级时间戳）（格式：2024-01-01 00:00:00）
        EndTime int64 `form:"endTime,optional"` // 结束时间（毫秒级时间戳）（格式：2024-01-31 23:59:59）
        Currency string `form:"currency,optional"` // 币种筛选
    }

    // 代理收益总览响应
    GetEarningsOverviewResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data EarningsOverviewData `json:"data"` // 数据
    }

    // 代理收益总览数据
    EarningsOverviewData {
        CustomerId int64 `json:"customerId"` // 客户ID
        AgentEmail string `json:"agentEmail"` // 代理邮箱
        AgentName string `json:"agentName"` // 代理姓名
        AgentType string `json:"agentType"` // 代理类型：super_agent-总代, agent-代理
        AgentLevel int32 `json:"agentLevel"` // 代理层级

        // 收益统计
        TotalEarnings string `json:"totalEarnings"` // 累计总收益（decimal字符串）
        AvailableBalance string `json:"availableBalance"` // 可提现余额（decimal字符串）
        FrozenAmount string `json:"frozenAmount"` // 冻结金额（decimal字符串）
        WithdrawnAmount string `json:"withdrawnAmount"` // 已提现金额（decimal字符串）

        // 本期收益（根据时间范围）
        PeriodEarnings string `json:"periodEarnings"` // 期间总收益（decimal字符串）
        DepositCommission string `json:"depositCommission"` // 存款佣金（decimal字符串）
        WithdrawalCommission string `json:"withdrawalCommission"` // 提现佣金（decimal字符串）
        ExchangeCommission string `json:"exchangeCommission"` // 换汇佣金（decimal字符串）
        OtherCommission string `json:"otherCommission"` // 其他佣金（decimal字符串）

        // 下级统计
        DirectSubCount int64 `json:"directSubCount"` // 直推下级数量
        TotalSubCount int64 `json:"totalSubCount"` // 总下级数量
        ActiveSubCount int64 `json:"activeSubCount"` // 活跃下级数量（期间内有交易）

        // 业绩统计
        TotalTransactionVolume string `json:"totalTransactionVolume"` // 总交易量（decimal字符串）
        TotalTransactionCount int64 `json:"totalTransactionCount"` // 总交易笔数

        // 币种统计
        CurrencyEarnings []CurrencyEarning `json:"currencyEarnings"` // 各币种收益统计

        // 更新时间
        LastSettlementTime int64 `json:"lastSettlementTime"` // 最后结算时间（毫秒级时间戳）
        UpdatedAt string `json:"updatedAt"` // 更新时间
    }

    // 币种收益统计
    CurrencyEarning {
        Currency string `json:"currency"` // 币种代码
        Earnings string `json:"earnings"` // 收益金额（decimal字符串）
        TransactionVolume string `json:"transactionVolume"` // 交易量（decimal字符串）
        TransactionCount int64 `json:"transactionCount"` // 交易笔数
    }

    // 收益明细列表请求
    ListEarningsReq {
        UserId int64 `path:"userId"` // 用户ID
        Page int64 `form:"page,default=1,optional"` // 页码
        PageSize int64 `form:"pageSize,default=10,optional"` // 每页数量

        // 搜索条件
        Keyword string `form:"keyword,optional"` // 关键词搜索（订单号、用户邮箱等）

        // 筛选条件
        EarningType string `form:"earningType,optional"` // 收益类型：deposit-存款佣金, withdrawal-提现佣金, exchange-换汇佣金, other-其他
        SourceType string `form:"sourceType,optional"` // 来源类型：direct-直推, indirect-间推
        Status string `form:"status,optional"` // 状态：pending-待结算, settled-已结算, frozen-已冻结, cancelled-已取消
        Currency string `form:"currency,optional"` // 币种筛选

        // 时间范围
        StartTime int64 `form:"startTime,optional"` // 开始时间（毫秒级时间戳）（格式：2024-01-01 00:00:00）
        EndTime int64 `form:"endTime,optional"` // 结束时间（毫秒级时间戳）（格式：2024-01-31 23:59:59）

        // 金额范围
        MinAmount string `form:"minAmount,optional"` // 最小金额
        MaxAmount string `form:"maxAmount,optional"` // 最大金额

        // 关联筛选
        SubUserId int64 `form:"subUserId,optional"` // 下级用户ID筛选
        TransactionId int64 `form:"transactionId,optional"` // 关联交易ID筛选
    }

    // 收益明细列表响应
    ListEarningsResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data EarningsListData `json:"data"` // 数据
    }

    // 收益明细列表数据
    EarningsListData {
        Total int64 `json:"total"` // 总记录数
        TotalEarnings string `json:"totalEarnings"` // 列表总收益（decimal字符串）
        List []EarningInfo `json:"list"` // 列表
    }

    // 收益明细信息
    EarningInfo {
        Id int64 `json:"id"` // ID
        EarningNumber string `json:"earningNumber"` // 收益单号
        CustomerId int64 `json:"customerId"` // 客户ID
        AgentEmail string `json:"agentEmail"` // 代理邮箱

        // 收益信息
        EarningType string `json:"earningType"` // 收益类型：deposit-存款佣金, withdrawal-提现佣金, exchange-换汇佣金, other-其他
        EarningTypeText string `json:"earningTypeText"` // 收益类型文本
        SourceType string `json:"sourceType"` // 来源类型：direct-直推, indirect-间推
        SourceTypeText string `json:"sourceTypeText"` // 来源类型文本
        Amount string `json:"amount"` // 收益金额（decimal字符串）
        Currency string `json:"currency"` // 币种
        CommissionRate string `json:"commissionRate"` // 佣金比例（百分比，如：5.00表示5%）

        // 关联信息
        SubUserId int64 `json:"subUserId"` // 下级用户ID
        SubUserEmail string `json:"subUserEmail"` // 下级用户邮箱
        SubUserType string `json:"subUserType"` // 下级用户类型
        SubUserLevel int32 `json:"subUserLevel"` // 下级用户层级（1-直推, 2-二级, 3-三级等）

        TransactionId int64 `json:"transactionId"` // 关联交易ID
        TransactionNumber string `json:"transactionNumber"` // 交易单号
        TransactionAmount string `json:"transactionAmount"` // 交易金额（decimal字符串）
        TransactionTime int64 `json:"transactionTime"` // 交易时间（毫秒级时间戳）

        // 状态信息
        Status string `json:"status"` // 状态：pending-待结算, settled-已结算, frozen-已冻结, cancelled-已取消
        StatusText string `json:"statusText"` // 状态文本
        SettlementTime int64 `json:"settlementTime"` // 结算时间（毫秒级时间戳）

        // 其他信息
        Description string `json:"description"` // 描述
        Note string `json:"note"` // 备注
        CreatedAt string `json:"createdAt"` // 创建时间
        UpdatedAt string `json:"updatedAt"` // 更新时间
    }

    // 收益明细详情响应
    GetEarningDetailResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data EarningInfo `json:"data"` // 数据
    }

    // 下级业绩统计请求
    GetSubUserPerformanceReq {
        UserId int64 `path:"userId"` // 用户ID
        StartTime int64 `form:"startTime,optional"` // 开始时间（毫秒级时间戳）（格式：2024-01-01 00:00:00）
        EndTime int64 `form:"endTime,optional"` // 结束时间（毫秒级时间戳）（格式：2024-01-31 23:59:59）
        Level int32 `form:"level,optional"` // 层级筛选（1-直推, 2-二级等，0或不传表示全部）
        Page int64 `form:"page,default=1,optional"` // 页码
        PageSize int64 `form:"pageSize,default=10,optional"` // 每页数量
        SortBy string `form:"sortBy,default=earnings,optional"` // 排序字段：earnings-收益, volume-交易量, count-交易笔数
        SortOrder string `form:"sortOrder,default=desc,optional"` // 排序方向：asc-升序, desc-降序
    }

    // 下级业绩统计响应
    GetSubUserPerformanceResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data SubUserPerformanceData `json:"data"` // 数据
    }

    // 下级业绩统计数据
    SubUserPerformanceData {
        Total int64 `json:"total"` // 总记录数
        Summary SubUserPerformanceSummary `json:"summary"` // 汇总数据
        List []SubUserPerformanceInfo `json:"list"` // 列表
    }

    // 下级业绩汇总
    SubUserPerformanceSummary {
        TotalEarnings string `json:"totalEarnings"` // 总收益（decimal字符串）
        TotalVolume string `json:"totalVolume"` // 总交易量（decimal字符串）
        TotalCount int64 `json:"totalCount"` // 总交易笔数
        ActiveUserCount int64 `json:"activeUserCount"` // 活跃用户数
    }

    // 下级用户业绩信息
    SubUserPerformanceInfo {
        CustomerId int64 `json:"customerId"` // 客户ID
        UserEmail string `json:"userEmail"` // 用户邮箱
        UserName string `json:"userName"` // 用户姓名
        UserType string `json:"userType"` // 用户类型
        UserLevel int32 `json:"userLevel"` // 用户层级（1-直推, 2-二级等）
        UserStatus int32 `json:"userStatus"` // 用户状态

        // 业绩数据
        TransactionVolume string `json:"transactionVolume"` // 交易量（decimal字符串）
        TransactionCount int64 `json:"transactionCount"` // 交易笔数
        GeneratedEarnings string `json:"generatedEarnings"` // 产生的收益（decimal字符串）

        // 时间信息
        RegisteredAt string `json:"registeredAt"` // 注册时间
        LastTransactionAt string `json:"lastTransactionAt"` // 最后交易时间

        // 下级统计
        SubUserCount int64 `json:"subUserCount"` // 该用户的下级数量
    }

    // 佣金比例配置请求
    GetCommissionConfigReq {
        UserId int64 `path:"userId"` // 用户ID
    }

    // 佣金比例配置响应
    GetCommissionConfigResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data CommissionConfigData `json:"data"` // 数据
    }

    // 佣金比例配置数据
    CommissionConfigData {
        CustomerId int64 `json:"customerId"` // 客户ID
        AgentType string `json:"agentType"` // 代理类型

        // 直推佣金比例（百分比）
        DirectDepositRate string `json:"directDepositRate"` // 直推存款佣金比例
        DirectWithdrawalRate string `json:"directWithdrawalRate"` // 直推提现佣金比例
        DirectExchangeRate string `json:"directExchangeRate"` // 直推换汇佣金比例

        // 间推佣金比例（百分比）
        IndirectDepositRate string `json:"indirectDepositRate"` // 间推存款佣金比例
        IndirectWithdrawalRate string `json:"indirectWithdrawalRate"` // 间推提现佣金比例
        IndirectExchangeRate string `json:"indirectExchangeRate"` // 间推换汇佣金比例

        // 层级配置
        MaxLevels int32 `json:"maxLevels"` // 最大返佣层级
        LevelRates []LevelRateConfig `json:"levelRates"` // 各层级佣金比例配置

        // 其他配置
        MinSettlementAmount string `json:"minSettlementAmount"` // 最小结算金额
        SettlementCycle string `json:"settlementCycle"` // 结算周期：daily-每日, weekly-每周, monthly-每月

        // 时间信息
        EffectiveFrom string `json:"effectiveFrom"` // 生效时间
        UpdatedAt string `json:"updatedAt"` // 更新时间
    }

    // 层级佣金比例配置
    LevelRateConfig {
        Level int32 `json:"level"` // 层级（1-直推, 2-二级等）
        DepositRate string `json:"depositRate"` // 存款佣金比例（百分比）
        WithdrawalRate string `json:"withdrawalRate"` // 提现佣金比例（百分比）
        ExchangeRate string `json:"exchangeRate"` // 换汇佣金比例（百分比）
    }

    // 收益趋势分析请求
    GetEarningsTrendReq {
        UserId int64 `path:"userId"` // 用户ID
        StartTime int64 `form:"startTime,optional"` // 开始时间（毫秒级时间戳）（格式：2024-01-01 00:00:00）
        EndTime int64 `form:"endTime,optional"` // 结束时间（毫秒级时间戳）（格式：2024-01-31 23:59:59）
        Granularity string `form:"granularity,default=day,optional"` // 粒度：day-按日, week-按周, month-按月
        Currency string `form:"currency,optional"` // 币种筛选
    }

    // 收益趋势分析响应
    GetEarningsTrendResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data EarningsTrendData `json:"data"` // 数据
    }

    // 收益趋势分析数据
    EarningsTrendData {
        Granularity string `json:"granularity"` // 粒度
        TotalEarnings string `json:"totalEarnings"` // 总收益（decimal字符串）
        AverageEarnings string `json:"averageEarnings"` // 平均收益（decimal字符串）
        DataPoints []EarningDataPoint `json:"dataPoints"` // 数据点列表
    }

    // 收益数据点
    EarningDataPoint {
        PeriodStart string `json:"periodStart"` // 周期开始时间
        PeriodEnd string `json:"periodEnd"` // 周期结束时间
        PeriodLabel string `json:"periodLabel"` // 周期标签（如：2024-01-01, 2024-W01, 2024-01）

        TotalEarnings string `json:"totalEarnings"` // 总收益（decimal字符串）
        DepositCommission string `json:"depositCommission"` // 存款佣金（decimal字符串）
        WithdrawalCommission string `json:"withdrawalCommission"` // 提现佣金（decimal字符串）
        ExchangeCommission string `json:"exchangeCommission"` // 换汇佣金（decimal字符串）
        OtherCommission string `json:"otherCommission"` // 其他佣金（decimal字符串）

        TransactionVolume string `json:"transactionVolume"` // 交易量（decimal字符串）
        TransactionCount int64 `json:"transactionCount"` // 交易笔数
        ActiveSubUserCount int64 `json:"activeSubUserCount"` // 活跃下级用户数
        NewSubUserCount int64 `json:"newSubUserCount"` // 新增下级用户数
    }

    // 导出收益报表请求
    ExportEarningsReq {
        UserId int64 `path:"userId"` // 用户ID
        StartTime int64 `json:"startTime,optional"` // 开始时间（毫秒级时间戳）
        EndTime int64 `json:"endTime,optional"` // 结束时间（毫秒级时间戳）（格式：2024-01-31 23:59:59）
        EarningType string `json:"earningType,optional"` // 收益类型筛选
        Status string `json:"status,optional"` // 状态筛选
        Currency string `json:"currency,optional"` // 币种筛选
        ExportType string `json:"exportType,default=summary,optional"` // 导出类型：summary-汇总报表, detail-明细报表, trend-趋势报表
    }

    // 导出收益报表响应
    ExportEarningsResp {
        Code int32 `json:"code"` // 响应码
        Message string `json:"message"` // 响应消息
        Data ExportEarningsData `json:"data"` // 数据
    }

    // 导出收益报表数据
    ExportEarningsData {
        TaskId string `json:"taskId"` // 任务ID
        FileName string `json:"fileName"` // 文件名
        FileSize int64 `json:"fileSize"` // 文件大小（字节）
        DownloadUrl string `json:"downloadUrl"` // 下载链接
        ExpireAt string `json:"expireAt"` // 过期时间
    }
)