## 目标

- **建设范围**: 管理端 + 用户端的开户与资金全流程平台。
- **核心能力**: 组织与权限、客户资料、账户开户与审核、入账审核、提现审核、资金流水可视化、全链路审计与幂等。

## 需求分解

### 管理端

- **菜单管理**
- **角色管理**: 创建角色、分配菜单与权限。
- **权限管理**
- **人员管理**: 添加人员、重设密码、分配角色。
- **用户管理**: 生成客户经理注册链接（一次性、与人员绑定、过期控制）。
- **客户管理**: 查看客户信息、查看所属用户、重设客户密码。
- **账户管理**: 账户列表、账户状态查询与变更。
- **开户审核**: 待审核/审核通过/审核失败。
- **入账审核**: 待审核/审核通过/审核失败；通过后入账计入可用并生成流水（前台可见）。
- **出金审核（提现）**: 待审核/审核通过/审核失败；通过扣减冻结，失败解冻返还。

### 用户端

- **个人资料**: 查看/更新个人信息。
- **密码管理**: 修改登录密码、设置资金密码、修改资金密码
- **钱包管理**: 查看钱包状态、余额、发起提现、绑定提现地址
- **资金明细**: 查看账户流水、余额、冻结额（仅可见审核通过后可见的流水）。
- **提现管理**: 发起提现申请、查看提现记录。
- **客户管理**: 添加客户资料（KYC/KYB）。
- **账户管理**: 发起开户申请。

## 主题流程（1-9）

1. 后台员工生成客户经理的**注册链接**（生成UID并与操作的员工绑定，设置换汇手续费、提款手续费）。
2. 客户经理通过链接注册**用户端**账号（完成邮箱验证码校验后绑定UID）。
3. 客户经理**添加客户资料**（含必要证照/联系人）。
4. 以客户资料**申请银行账户开户**（生成开户申请，待审核）。
5. 后台员工**初审开户申请**（通过初审 → 将开户申请提交到银行接口进行开户；初审失败 → 附拒绝原因）。
6. 银行**外部接口回调**将入账流水录入后台（记录 webhook 幂等）。
7. 后台员工**审核入账流水**（通过 → 将银行入账币种换汇后扣除手续费，加到用户的指定钱包并生成流水，前台可见；失败 → 不入账）。
8. 用户端**发起提现**：选择钱包；确认提现地址有效；提现金额扣除手续费后大于最少提现金，可用余额减少，转为冻结；前后台出现提现申请。
9. 后台员工**审核提现**：通过 → 冻结余额扣减；失败 → 冻结转回可用；前后台状态同步更新。

## 领域模型

### 后台组织与权限（Admin）

- **Role**: 角色实体（名称、描述、状态）。
- **Menu**: 菜单实体（名称、路径、图标、排序、父级）。
- **Permission**: 权限点，建议资源+动作（如 customer:read、account:approve、withdrawal:review）。
- **Staff**: 人员（后台员工）。
- **Log**: 后台管理日志、人员变动、密码重设

### 前台用户（IAM）
- **User**: UID绑定后台员工ID
- **UserInvite**: 后台生成邀请码、绑定后台员工ID
- **UserCredential**: 用户登录密码、资金密码
- **UserCredentialLog**: 用户凭证操作记录
- **UserProfile**: 用户资料
- **UserEmail**: 用户邮箱
- **UserEmailLog**: 邮箱操作记录
- **UserSession**: 用户登录会话、凭证
- **UserSessionLog**: 用户登录日志、会话操作记录、操作人

### 用户钱包相关（FAMS）
- **UserSetting**: 市场部负责设置用户的换汇手续费、提款手续费
- **UserWallet**: 绑定提现地址时自动生成钱包、后台人员审核入账时如果没有钱包自动生成
- **UserWalletLedger**: 钱包余额明细
- **UserWalletAddress**: 钱包地址绑定
- **UserWalletAddressLog**: 钱包地址变动记录
- **UserWalletAddressAudit**: 提现部门负责钱包地址审核

### 银行业务相关（FAMS）
- **BankCustomer**: 银行客户资料
- **BankAccount**: 银行账户（账号、状态）。
- **BankAccountApplication**: 开户申请（客户、材料、状态、审核记录）资料审核部门负责审核
- **BankWebhookRecord**: 银行回调记录（幂等键、签名校验、payload 哈希、处理状态、重试信息）。

### 资金存款提现与审核（FAMS）
- **UserWalletDeposit**: 用户钱包存款记录。银行存款审核（来源流水、金额、状态、审核意见）。
- **UserWalletWithdrawal**: 用户钱包提现记录，提现审核单（审核人、状态、意见）。


## 状态机

### 开户申请（AccountApplicationStatus）

- Draft → Submitted → UnderReview → Approved → Rejected（终态）

### 银行账户（BankAccountStatus）

- NotOpened → PendingApproval → Opened → Frozen → Closed

### 入账审核（DepositReviewStatus）

- Pending → Approved → Rejected

### 提现（WithdrawalStatus）

- Requested（冻结发生）→ UnderReview → Approved（扣减冻结）/ Rejected（解冻返还）→ Settled/Closed

## 权限与可见性

- **后台审批权限隔离**: 仅具有审批权限者可执行开户/入账/提现审核。
- **最小权限**: 管理端按角色分配菜单与权限；客户经理仅能操作名下客户与账户；客户仅能操作个人账户与资金。
- **流水可见性**: Transaction.visibleForFrontend 控制前台展示（入账未通过不展示）。

## 流程与时序

### 入账

- 银行 → 后台：Webhook（签名/幂等等）→ 生成待审核入账单 → 审核通过 → 账户可用余额增加 & 生成流水（前台可见）。

### 提现

- 客户提交请求（可用 → 冻结）→ 后台审核通过 → 冻结扣减 & 下发出金指令 → 状态更新（前台可见）。
- 若审核拒绝 → 解冻返还可用。

### 开户

- 前台提交开户申请 → 后台审核 → 通过后创建并激活银行账户。

## 关键业务规则

### 注册邀请

- 后台生成邀请链接；单链接单次使用，与指定 Staff 绑定；注册成功即刻作废；未被使用时自生成起 24 小时内有效，逾期失效。

### 邮箱验证码

- 客户经理注册时必须输入邮箱验证码；
- 验证码发送频控（如每分钟 1 次、每日上限可配置）；
- 验证码有效期建议 10 分钟；
- 校验通过后方可完成基于邀请链接的注册与绑定；
- 验证码错误次数过多触发短暂锁定（如 5 分钟，阈值可配）。

### 金额与账户

- 入账通过后才计入可用余额；
- 提现申请前校验可用余额 ≥ 申请额；
- 冻结/解冻/扣减必须在数据库事务中完成并生成对应流水。

### 幂等与一致性

- 银行 webhook 幂等键（交易流水号+渠道）；
- 重试策略与签名校验必需；
- 审核通过/拒绝均记录审核人、时间、意见；
- 任何资金变更必须落账流水并写审计日志。

### 安全

- 密码重设需强校验与二次确认；
- 敏感操作记录操作日志与可选二次认证；
- 存储加密、传输加密、最小权限、密码复杂度策略与风控。

## 非功能性

- **审计合规**: 全量操作审计、资金流水不可篡改（建议事件溯源或至少追加写）。
- **事务一致性**: 资金相关操作必须在事务中完成，避免可用/冻结不一致。
- **可观察性**: 指标（审核通过率、处理时延）、结构化日志与告警。
- **性能**: 并发 webhook 处理；各列表分页/筛选；审核队列水平扩展。
- **安全合规**: 加密、最小权限、密码策略、风控黑名单与限额。

## 技术栈（约定）

- **后端框架**: go-zero（API 使用 REST 网关，内部服务可用 zrpc）。
- **鉴权与权限**: go-zero 中间件 + JWT；基于角色/菜单/权限点的 RBAC；网关与 RPC 间权限传递与校验。
- **数据访问（ORM）**: 使用 GORM；开启严格事务边界，资金相关写入必须使用事务；金额字段使用 Decimal/或最小货币单位整数存储；统一时区与时间精度。
- **任务与异步**: 结合 go-zero 的异步组件/队列（用于 webhook 重试、审核通知等）。
- **配置与启动**: 标准 go-zero 配置文件（yaml/json），区分 dev/stage/prod。

## API 文档生成（go-zero）

- **定义位置**: 为 Admin 与 客户端 两套接口分别维护 `.api` 描述文件（如 `admin.api`、`client.api`），统一在 `.api` 中声明分组、路由、请求/响应模型与公共请求头。
- **公共请求头声明**: 在 `.api` 的 `@server`/`@doc` 或 group 级声明中定义 `Authorization`, `timestamp`, `sign` 的说明，确保生成文档自动带出。
- **生成 OpenAPI/Swagger**: 使用 `goctl-swagger` 插件从 `.api` 生成 Swagger 文件。
  - 示例命令：
    - Admin：`goctl api plugin -plugin goctl-swagger="swagger -filename admin.json -host api.example.com" -api ./api/admin.api -dir ./docs/swagger`
    - Client：`goctl api plugin -plugin goctl-swagger="swagger -filename client.json -host api.example.com" -api ./api/client.api -dir ./docs/swagger`
  - 也可生成 YAML：`... "swagger -filename client.yaml -yaml" ...`
- **接口分组与前缀**:
  - Admin API 使用 `basePath=/admin`，Tag 统一为 `Admin`。
  - 客户端 API 使用 `basePath=/api`，Tag 统一为 `Client`。
- **CI 集成**: 在 CI 中新增步骤按分支生成 `docs/swagger/admin.json` 与 `docs/swagger/client.json` 并作为构件产出；前端使用该文件生成/校验 SDK。
- **版本化**: 推荐在 `.api` 顶部标注 `@version`，并按发布迭代生成 `vX` 目录保存历史规范。

## RPC 拆分建议（go-zero zrpc）

### 总体原则

- **单一职责与数据归属**: 每个服务独立拥有其核心数据的写权限与数据库表；跨域仅通过 RPC 调用交互。
- **同步 + 异步**: 读少写多且强一致用 RPC，同步链路尽量短；资金类写操作采用本地事务，其他联动通过同步 RPC 调用。
- **幂等与防重放**: 资金、回调、审核接口均需幂等键；RPC 层统一传递 `requestId`。
- **向前兼容**: RPC 接口优先向前兼容演进，避免破坏性变更；按 `v1/v2` 版本管理。

### 服务边界（5 个服务）

- **admin-rpc**: 管理端业务（角色/菜单/权限管理、人员管理、客户管理、账户管理、三类审核：开户/入账/提现）。
- **fams-rpc**: 金融账户管理系统（Financial Account Management System）- 银行账户生命周期、开户申请、资金账本（available/frozen）、交易流水记账、提现申请与处理。
- **iam-rpc**: 身份与访问管理（Identity and Access Management）- 角色/菜单/权限点、人员（Staff）管理、邀请链接生成/查询/作废、客户经理用户（User）注册与绑定。
- **otp-rpc**: 一次性密码服务（One-Time Password）- 邮箱验证码生成/校验/频控、短信验证码（如需要）、验证码错误锁定策略。
- **auth-rpc**: 认证服务 - 登录/登出、JWT 签发与校验、签名策略下发（公钥）、会话管理。

说明：`fams-rpc` 作为核心资金服务，不直接对外暴露给前端；所有资金变更由 `admin-rpc` 在审核通过后调用 `fams-rpc` 执行记账；`otp-rpc` 为纯验证码服务，被 `iam-rpc` 和 `auth-rpc` 调用。

### 典型调用关系

- 注册：`client → iam-rpc`（校验邀请）→ `otp-rpc`（验证码）→ `iam-rpc` 完成用户绑定 → `auth-rpc` 签发 JWT。
- 提现：`client → fams-rpc.CreateWithdrawal()`（先调 `fams-rpc.Freeze()` 冻结）→ `admin-rpc` 审核通过 → 出金成功回执 → 调 `fams-rpc.DeductFrozen()`；若拒绝 → `fams-rpc.Unfreeze()`。

### 数据库与事务

- 所有服务共享同一个数据库（按业务域分表），避免跨库事务问题。
- 跨服务操作使用同步 RPC 调用，失败时通过补偿机制处理。
- 资金相关方法在 `fams-rpc` 内部采用数据库事务（含余额、冻结额与流水写入同一事务）。
- 审核通过/拒绝操作在 `admin-rpc` 内仅做状态流转与调用下游，避免直接写资金表。

### 接口与模型

- goctl 生成 `*.proto` 与服务桩，统一在 `api/idl` 目录维护；消息字段命名统一 snake_case。
- 请求统一包含：`request_id`、`operator`（操作者身份、权限、部门）、`timestamp`；资金操作包含 `idempotency_key`。
- **RPC 权限校验**：
  - 每个 RPC 方法定义所需权限（如 `account:approve`、`withdrawal:review`）。
  - RPC 服务接收请求时校验 `operator.permissions` 是否包含所需权限。
  - 跨服务调用时传递完整的 `operator` 上下文，保持权限链完整。
  - 资金相关 RPC 方法强制校验操作者身份与权限，记录审计日志。
- 返回统一：`code`、`message`、`data`；错误码分域分段。

### 网关与路由

- HTTP（/admin, /api）走 API 网关；内部调用使用 zrpc；避免前端直连任何 rpc。
- 网关路由：`/admin/*` → `admin-rpc`；`/api/*` → `iam-rpc` + `fams-rpc` + `auth-rpc`。
- **网关与 RPC 权限验证**：
  - 网关解析 JWT，提取用户身份（staffId/userId）、角色、权限列表。
  - 网关调用 RPC 时传递 `operator` 上下文（包含身份、权限、部门等信息）。
  - RPC 服务接收请求时校验 `operator` 权限，拒绝无权限调用。
  - 敏感操作（资金变更、审核）在 RPC 层再次校验权限与操作者身份。
- 限流与熔断在网关与关键 RPC 层同时配置（读多链路网关限流，写多链路服务限流）。

### 观测与告警

- 每个服务暴露 metrics（QPS、RT、错误率、重试/丢弃计数）；trace 贯穿网关 →RPC→DB。
- 关键事件（资金入账、提现）写审计表并推送告警渠道（如企业微信/飞书）。

## 接口安全与签名（前后端校验）

- **公共请求头/字段**: `Authorization`（`Bearer <JWT>`，需鉴权的接口必填）、`timestamp`（毫秒/秒级时间戳）、`sign`（签名字符串）。
- **签名目的**: 防参数篡改、防重放、确保接口请求来源合法。
- **签名规则（参数排序 + 公钥拼接）**:
  1. 取本次请求的全部参与签名的参数（Query + Body 表单/JSON 的一层 key；文件上传建议仅参与元参数），连同 `timestamp` 一起参与；排除 `sign` 自身。
  2. 按参数名进行字典序（ASCII）升序排序。
  3. 拼接为 `key1=value1&key2=value2&...&keyN=valueN` 的 canonical 字符串（值做去首尾空白；如为 JSON/数组，需先做稳定序列化）。
  4. 在结尾直接拼接公钥：`canonicalString + publicKey`。
  5. 计算摘要作为签名：`sign = UPPERCASE(HEX(SHA256(canonicalString + publicKey)))`（如需国密，可改为 `SM3`）。
- **服务端验签**:
  1. 校验时间窗口：允许 ±5 分钟；超窗拒绝（防重放）。
  2. 依据相同规则重建 canonical 字符串，拼接公钥计算摘要，与来参 `sign` 比对（常量时序比较）。
  3. 可选：接入 `nonce` 防重复使用（短期缓存去重）。
- **错误处理**: 头缺失/超时/签名不一致 → 401/403；记录审计日志与来路信息。
- **实现位置**: 前端统一封装签名拦截器；后端基于 go-zero 中间件统一验签。

说明：登录/注册、发送邮箱验证码等开放接口通常不要求 `Authorization`，但仍需携带 `timestamp` 与 `sign` 并通过验签；其余需要登录态的接口均要求 `Authorization: Bearer <JWT>`。

## 设计摘要

- **分层架构**: 接口层（REST/gRPC+Webhook）/应用层（用例编排）/领域层（实体、仓储接口、领域服务）/基础设施（存储、银行适配器、消息）。
- **资金记账**: 双余额模型 availableBalance/frozenBalance；所有变动生成 Transaction。
- **审核流**: 审核单与业务实体分离；审核通过时触发领域服务进行状态迁移与记账。
- **可见性**: 入账审核通过后将 Transaction.visibleForFrontend 设为 true。
- **幂等与签名**: BankWebhookRecord(idempotencyKey, signature, payloadHash, status)。

## API 草案（简要）

> 公共请求头：`timestamp`, `sign`（详见“接口安全与签名”）。
>
> 命名空间与密钥隔离：
>
> - Admin API 使用 `/admin` 前缀，采用独立的密钥/公钥对与权限策略。
> - 客户端 API 统一使用 `/api` 前缀，采用独立的密钥/公钥对与权限策略。

### Admin API

#### 角色管理

- POST /admin/roles（创建角色）
- GET /admin/roles（角色列表，支持分页/搜索）
- GET /admin/roles/{id}（角色详情）
- PUT /admin/roles/{id}（更新角色信息）
- DELETE /admin/roles/{id}（删除角色）
- GET /admin/roles/{id}/menus（角色菜单列表）
- POST /admin/roles/{id}/menus（分配菜单）
- DELETE /admin/roles/{id}/menus/{menuId}（移除菜单）
- GET /admin/roles/{id}/permissions（角色权限列表）
- POST /admin/roles/{id}/permissions（分配权限）
- DELETE /admin/roles/{id}/permissions/{permissionId}（移除权限）

#### 菜单管理

- POST /admin/menus（创建菜单）
- GET /admin/menus（菜单树形列表）
- GET /admin/menus/{id}（菜单详情）
- PUT /admin/menus/{id}（更新菜单信息）
- DELETE /admin/menus/{id}（删除菜单）

#### 人员管理

- POST /admin/staff（添加人员）
- GET /admin/staff（人员列表，支持分页/搜索/角色筛选）
- GET /admin/staff/{id}（人员详情）
- PUT /admin/staff/{id}（更新人员信息）
- DELETE /admin/staff/{id}（删除人员）
- PATCH /admin/staff/{id}/password（重设密码）
- PATCH /admin/staff/{id}/role（设置角色）
- PATCH /admin/staff/{id}/status（启用/禁用）
- GET /admin/staff/{id}/menus（人员菜单）

#### 用户管理（注册链接）

- POST /admin/invite-links（生成注册链接）
- GET /admin/invite-links（链接列表，支持分页/状态筛选）
- GET /admin/invite-links/{id}（链接详情）
- PATCH /admin/invite-links/{id}/revoke（撤销链接）
- GET /admin/invite-links/{id}/usage（链接使用记录）

#### 客户管理

- GET /admin/customers（客户列表，支持分页/搜索/用户筛选）
- GET /admin/customers/{id}（客户详情）
- PUT /admin/customers/{id}（更新客户信息）
- PATCH /admin/customers/{id}/password（重设客户密码）
- GET /admin/customers/{id}/accounts（客户账户列表）
- GET /admin/customers/{id}/transactions（客户交易流水）

#### 账户管理

- GET /admin/accounts（账户列表，支持分页/搜索/状态筛选）
- GET /admin/accounts/{id}（账户详情）
- PATCH /admin/accounts/{id}/status（账户状态变更）
- GET /admin/accounts/{id}/transactions（账户交易流水）
- GET /admin/accounts/{id}/balance（账户余额详情）

#### 开户审核

- GET /admin/account-applications（开户申请列表，支持分页/状态筛选）
- GET /admin/account-applications/{id}（申请详情）
- POST /admin/account-applications/{id}/approve（审核通过）
- POST /admin/account-applications/{id}/reject（审核拒绝）
- GET /admin/account-applications/{id}/materials（申请材料）

#### 入账审核

- GET /admin/deposit-reviews（入账审核列表，支持分页/状态筛选）
- GET /admin/deposit-reviews/{id}（审核详情）
- POST /admin/deposit-reviews/{id}/approve（审核通过）
- POST /admin/deposit-reviews/{id}/reject（审核拒绝）
- GET /admin/deposit-reviews/{id}/source（来源流水详情）

#### 提现审核

- GET /admin/withdrawal-reviews（提现审核列表，支持分页/状态筛选）
- GET /admin/withdrawal-reviews/{id}（审核详情）
- POST /admin/withdrawal-reviews/{id}/approve（审核通过）
- POST /admin/withdrawal-reviews/{id}/reject（审核拒绝）
- GET /admin/withdrawal-reviews/{id}/request（提现申请详情）

#### 系统管理

- GET /admin/dashboard/stats（仪表板统计数据）
- GET /admin/audit-logs（审计日志，支持分页/搜索/时间筛选）
- GET /admin/system/config（系统配置）
- PUT /admin/system/config（更新系统配置）

### 客户端 API

#### 认证与注册

- POST /api/auth/send-email-code（发送邮箱验证码）
- POST /api/auth/register-by-invite（客户经理通过邀请链接注册）
- POST /api/auth/register-customer（客户通过客户经理注册）
- POST /api/auth/login（登录）
- POST /api/auth/logout（登出）
- POST /api/auth/refresh-token（刷新令牌）
- GET /api/auth/profile（获取当前用户信息）
- PUT /api/auth/profile（更新用户信息）
- PATCH /api/auth/password（修改密码）

#### 客户管理（仅客户经理）

- POST /api/customers（添加客户）
- GET /api/customers（客户列表，支持分页/搜索）
- GET /api/customers/{id}（客户详情）
- PUT /api/customers/{id}（更新客户信息）
- DELETE /api/customers/{id}（删除客户）
- GET /api/customers/{id}/accounts（客户账户列表）
- GET /api/customers/{id}/transactions（客户交易流水）

#### 账户管理

- POST /api/account-applications（提交开户申请）
- GET /api/account-applications（开户申请列表，支持分页/状态筛选）
- GET /api/account-applications/{id}（申请详情）
- GET /api/accounts（账户列表，支持分页/客户筛选）
- GET /api/accounts/{id}（账户详情）
- GET /api/accounts/{id}/balance（账户余额）
- GET /api/accounts/{id}/transactions（账户交易流水）

#### 资金管理

- GET /api/funds/summary（资金总览）
- GET /api/funds/transactions（所有交易流水，支持分页/筛选）
- GET /api/funds/transactions/{id}（交易详情）

#### 提现管理

- POST /api/withdrawals（申请提现）
- GET /api/withdrawals（提现记录，支持分页/状态筛选）
- GET /api/withdrawals/{id}（提现详情）
- POST /api/withdrawals/{id}/cancel（取消提现申请）

### 银行回调

- POST /webhooks/bank/deposits（签名校验/幂等等）

## 数据校验与风控

- **金额精度**: 使用 Decimal/或最小货币单位整型；禁止二进制浮点。
- **重复入账**: 依幂等键拒绝重复；金额不一致需标红人工复核。
- **提现风控**: 单笔限额、日累计限额、黑名单账户拦截、异常频次告警。
- **邀请安全**: 强随机 token、一次性、过期校验、与 Staff 绑定不可篡改。

## 页面清单（概要）

### 管理端

- 角色、菜单、人员、用户（注册链接）
- 客户、账户
- 审核列表：开户/入账/提现（列表与详情）
- 流水查询与对账视图

### 用户端

- 客户经理：客户管理、开户申请
- 客户：个人资料、账户管理、资金明细、提现申请与记录

## 小结

- 明确管理端/用户端职责边界与权限模型。
- 设计开户、入账、提现三大审核流的状态机与记账规则。
- 提供关键接口草案、风控与幂等策略，保障资金一致性与可追溯。
