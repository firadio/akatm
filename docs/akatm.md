## 目标

- **建设范围**: 管理端 + 用户端的开户与资金全流程平台。
- **核心能力**: 组织与权限、客户资料、账户开户与审核、入账审核、提现审核、资金流水可视化、全链路审计与幂等。

## 需求分解

### 管理端
- **菜单管理**: 
- **角色管理**: 创建角色、分配菜单与权限。
- **人员管理**: 添加人员、重设密码、分配角色。
- **用户管理**: 添加总代、配置开户国家列表、换汇手续费、重设代理或用户密码
- **邀请链接管理**: 查看管理邀请链接
- **客户管理**: 查看客户信息、查看所属用户。
- **账户管理**: 账户列表、账户状态查询与变更。
- **开户审核**: 待审核/审核通过/审核失败。
- **开户国家列表**: 开户国家管理
- **入账审核**: 待审核/审核通过/审核失败；通过后入账计入可用并生成流水（前台可见）。
- **出金审核（提现）**: 待审核/审核通过/审核失败；通过扣减冻结，失败解冻返还。
- **资金明细**:

### 前台代理功能
- **用户管理**: 设置每个用户的换汇手续费必须大于等于自身的手续费（总代和代理才有这个功能）
- **邀请链接管理**: 生成链接（一次性、与用户绑定、过期控制），修改注册链接（设置换汇手续费，必须大于等于自身的手续费）。
- **报表查询**: 要能够查到代理和用户的客户存款、提现量。

### 前台客户经理功能
- **个人资料**: 查看/更新个人信息。
- **密码管理**: 修改登录密码、设置资金密码、修改资金密码
- **安全中心**: 邮箱绑定、谷歌验证（后台设置是否强制开启）
- **钱包管理**: 查看钱包状态、余额、发起提现、绑定提现地址
- **资金明细**: 查看账户流水、余额、冻结额（仅可见审核通过后可见的流水）。
- **提现管理**: 发起提现申请、查看提现记录。
- **客户管理**: 添加客户资料（KYC/KYB）。
- **账户管理**: 发起开户申请。

### 关于前台角色
前台共有3种角色：客户经理、代理、总代
不同的角色可以管理不同的角色
总代：只有后台能够添加总代，总代只能添加代理，总代不能提现。
代理：只有总代能够添加代理，代理只能添加客户经理，代理不能添加代理（后期可能要求代理可以添加代理，但这个改动不大）。
客户经理：只有代理能够添加客户经理，客户经理没有代理功能（用户管理、链接注册、报表查询）。

### 关于授权开户国家列表
例如授权给总代的国家是UK和US，总代就只能给代理分配这2个国家了。
如果总代只给代理分配了UK，那么代理开出来的用户就只能是UK的权限

### 关于换汇手续费
假设平台设置了最小精度是1%，最小点差是0%，最大手续费100%。
例如平台给总代设置的是5%的换汇手续费，那么总代给代理就只能设置最少5%、6%、7%、直到100%

### 关于提现手续费
假设平台设置了最小精度是1.00USD，最小差额是0.00USD，最大手续费100USD。
例如平台给总代设置的是5.00USD的提现手续费，那么总代给代理就只能设置最少5.00USD或6.00USD或7.00USD这种直到100USD



## 主题流程（1-9）
01. 后台添加总代账号（设置换汇手续费、提款手续费、设置允许开户国家列表）
02. 总代可以生成代理的注册链接（注册后与总代绑定，设置换汇手续费、提款手续费、设置允许开户国家列表）。
03. 通过注册链接注册成为代理、代理可以生成客户经理的**注册链接**（注册后与代理绑定，设置换汇手续费、提款手续费、设置允许开户国家列表）。
04. 客户经理通过链接注册**用户端**账号（完成邮箱验证码校验后绑定UID）。
05. 客户经理**添加客户资料**（含必要证照/联系人）。
06. 以客户资料**申请银行账户开户**（生成开户申请，待审核）。
07. 后台员工**初审开户申请**（通过初审 → 将开户申请提交到银行接口进行开户；初审失败 → 附拒绝原因）。
08. 银行**外部接口回调**将入账流水录入后台（记录 webhook 幂等）。
09. 后台员工**审核入账流水**（通过 → 将银行入账币种换汇后扣除手续费，加到用户的指定钱包并生成流水，前台可见；失败 → 不入账）。
10. 用户端**发起提现**：选择钱包；确认提现地址有效；提现金额扣除手续费后大于最少提现金，可用余额减少，转为冻结；前后台出现提现申请。
11. 后台员工**审核提现**：通过 → 冻结余额扣减；失败 → 冻结转回可用；前后台状态同步更新。



## 领域模型

### 后台组织与权限（Admin）
- **Role**: 角色实体（名称、描述、状态）。
- **Menu**: 菜单实体（名称、路径、图标、排序、父级）。
- **Permission**: 权限点，建议资源+动作（如 customer:read、account:approve、withdrawal:review）。
- **Staff**: 人员（后台员工）。
- **Log**: 后台管理日志、人员变动、密码重设

### 前台用户（IAM）
- **User**: 前台用户表，有usertype、parent_id和parent_tree可以查到用户类型和用户层级
- **UserInvite**: 总代或代理生成邀请码
- **UserCredential**: 用户登录密码、资金密码、绑定谷歌验证器
- **UserCredentialLog**: 用户凭证操作记录
- **UserProfile**: 用户资料
- **UserEmail**: 用户邮箱
- **UserEmailLog**: 邮箱操作记录
- **UserSession**: 用户登录会话、凭证
- **UserSessionLog**: 用户登录日志、会话操作记录、操作人

### 用户钱包相关（FAMS）
- **UserSetting**: 市场部负责设置用户的换汇手续费、提款手续费
- **UserWallet**: 绑定提现地址时自动生成钱包、后台人员审核入账时如果没有钱包自动生成
- **UserWalletLedger**: 钱包余额明细
- **UserWalletAddress**: 钱包地址绑定
- **UserWalletAddressLog**: 钱包地址变动记录
- **UserWalletAddressAudit**: 提现部门负责钱包地址审核

### 银行业务相关（FAMS）
- **BankCustomer**: 银行客户资料
- **BankAccount**: 银行账户（账号、状态）。
- **BankAccountApplication**: 开户申请（客户、材料、状态、审核记录）资料审核部门负责审核
- **BankWebhookRecord**: 银行回调记录（幂等键、签名校验、payload 哈希、处理状态、重试信息）。

### 资金存款提现与审核（FAMS）
- **UserWalletDeposit**: 用户钱包存款记录。银行存款审核（来源流水、金额、状态、审核意见）。
- **UserWalletWithdrawal**: 用户钱包提现记录，提现审核单（审核人、状态、意见）。

